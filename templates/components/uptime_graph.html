<section class="@container">
  {% if let Some(data) = uptime_graph %}
    <section class="bg-surface rounded-md shadow-md mt-3">
      <div
        class="h-12 w-full py-3 px-2 flex flex-row-reverse gap-1"
        id="uptime_graph"
      >
        {% for ping in data %}
          <div
            class="{% if ping.bad %}bg-love{% else %}bg-pine{% endif %} w-full h-full rounded-md"
            data-timestamp="{{ ping.timestamp }}"
            data-duration="{{ ping.duration_ms }}"
            data-bad="{{ ping.bad }}"
          ></div>
        {% endfor %}
        {% for i in (0 .. 30 - data.len()) %}
          <div class="bg-overlay w-full h-full rounded-md"></div>
        {% endfor %}
      </div>
    </section>

    <div
      class="mt-3 p-3 relative w-full aspect-[16/9] bg-surface shadow-md rounded-md overflow-hidden"
    >
      <div id="uptime_chart" class="h-full w-[calc(100%+20px)]"></div>
    </div>

    <section
      class="bg-surface rounded-md shadow-md mt-3 gap-3 text-center grid grid-rows-3 @lg:grid-rows-none @lg:grid-cols-3 p-3"
    >
      <div>
        <h4 class="font-semibold text-xl">Average response</h4>
        <p class="text-md">
          {{ crate::database::Monitor::get_average_ping_duration(data) }}ms
        </p>
      </div>
      <div>
        <h4 class="font-semibold text-xl">Last response</h4>
        {% if let Some(val) = data.first() %}
          <p class="text-md">{{ val.duration_ms }}ms</p>
        {% else %}
          <p>Not available</p>
        {% endif %}
      </div>
      <div>
        <h4 class="font-semibold text-xl">Interval</h4>
        <p class="text-md">Every {{ monitor.interval }} seconds</p>
      </div>
    </section>
  {% else %}
    <p>No data</p>
  {% endif %}
</section>

<script>
  (() => {
    const children = Array.from($("#uptime_graph").children).reverse();

    const data = { labels: [], values: [] };
    for (const ping of children) {
      const attrs = dattributes(ping, ["duration", "timestamp"]);

      data.values.push(attrs.duration);
      if (attrs.timestamp) data.labels.push(new Date(attrs.timestamp));
    }

    /**
     * Format a date to HH:MM
     * @param {Date} date
     * @returns {string}
     */
    function formatDate(date) {
      const iso = date.toISOString();
      return iso.match(/\d\d:\d\d/)[0];
    }

    new Chartist.Line(
      "#uptime_chart",
      {
        labels: data.labels.map((date, i) =>
          i % 2 !== 0 ? "" : formatDate(date),
        ),
        series: [data.values],
      },
      {
        lineSmooth: Chartist.Interpolation.none(),
        axisY: {
          labelInterpolationFnc: (value) => value + "ms",
        },
      },
    );
  })();
</script>
